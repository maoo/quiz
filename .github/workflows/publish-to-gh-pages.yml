name: Publish to GitHub Pages

on:
  workflow_run:
    workflows: ["Convert SVG to PDF"]
    types:
      - completed
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install dependencies
        run: poetry install

      - name: Create gh-pages branch if it doesn't exist
        run: |
          if ! git show-ref --verify --quiet refs/heads/gh-pages; then
            git checkout --orphan gh-pages
            git rm -rf .
            git commit --allow-empty -m "Initial gh-pages commit"
            git push origin gh-pages
          fi

      - name: Checkout gh-pages branch
        run: |
          git fetch origin gh-pages
          git checkout gh-pages

      - name: Copy generated files
        run: |
          # Create necessary directories
          mkdir -p docs
          
          # Copy markdown files
          cp -r decks/*/questions/decks/*/docs/* docs/ 2>/dev/null || true
          
          # Copy SVG files
          mkdir -p svg
          cp -r decks/*/questions/*/card.svg svg/ 2>/dev/null || true
          
          # Copy PDF files
          mkdir -p pdf
          cp -r decks/*/questions/*/card.pdf pdf/ 2>/dev/null || true
          
          # Create index.html
          cat > index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>Quiz Documentation</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
              h1 { color: #333; }
              .section { margin-bottom: 30px; }
              a { color: #0366d6; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>Quiz Documentation</h1>
            <div class="section">
              <h2>Markdown Documentation</h2>
              <ul>
                $(find docs -name "*.md" | sed 's|^docs/|                <li><a href="|;s|$|">|;s|/|</a></li>|')
              </ul>
            </div>
            <div class="section">
              <h2>SVG Files</h2>
              <ul>
                $(find svg -name "*.svg" | sed 's|^svg/|                <li><a href="|;s|$|">|;s|/|</a></li>|')
              </ul>
            </div>
            <div class="section">
              <h2>PDF Files</h2>
              <ul>
                $(find pdf -name "*.pdf" | sed 's|^pdf/|                <li><a href="|;s|$|">|;s|/|</a></li>|')
              </ul>
            </div>
          </body>
          </html>
          EOF

      - name: Commit and push to gh-pages
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "Update documentation and generated files" || exit 0
          git push origin gh-pages

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: . 